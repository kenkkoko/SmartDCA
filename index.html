<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart DCA</title>
    <link rel="icon" type="image/png" href="app-icon.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon-ios.png?v=3" />
    <link rel="manifest" href="manifest.json" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Smart DCA">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { background-color: #0f172a; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- GitHub Actions æœƒè‡ªå‹•æ›¿æ›é€™äº› Placeholder ---
        // è«‹å‹¿æ›´å‹•é€™è£¡çš„å­—ä¸²ï¼Œä»¥å…éƒ¨ç½²å¤±æ•—
        const SUPABASE_URL = '__SUPABASE_URL_PLACEHOLDER__';
        const SUPABASE_ANON_KEY = '__SUPABASE_ANON_KEY_PLACEHOLDER__';
        const GEMINI_API_KEY = '__GEMINI_API_KEY_PLACEHOLDER__';
        
        // Lemon Squeezy è¨­å®š
        const LEMON_CHECKOUT_URL = 'https://smartdca.lemonsqueezy.com/buy/931e6d89-3193-4216-8c9b-a2d88c6e4acc';
        const LEMON_PORTAL_URL = 'https://smartdca.lemonsqueezy.com/billing';

        // åˆå§‹åŒ– Supabase
        const supabase = (typeof window.supabase !== 'undefined' && !SUPABASE_URL.includes('PLACEHOLDER'))
            ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
            : null;

        // --- Icons ---
        const IconBase = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Icons = {
            Bell: (props) => <IconBase {...props}><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9" /><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0" /></IconBase>,
            TrendingUp: (props) => <IconBase {...props}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18" /><polyline points="17 6 23 6 23 12" /></IconBase>,
            AlertTriangle: (props) => <IconBase {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" /><line x1="12" y1="9" x2="12" y2="13" /><line x1="12" y1="17" x2="12.01" y2="17" /></IconBase>,
            Info: (props) => <IconBase {...props}><circle cx="12" cy="12" r="10" /><line x1="12" y1="16" x2="12" y2="12" /><line x1="12" y1="8" x2="12.01" y2="8" /></IconBase>,
            RefreshCw: (props) => <IconBase {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" /><path d="M21 3v5h-5" /><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" /><path d="M8 16H3v5" /></IconBase>,
            ArrowUp: (props) => <IconBase {...props}><line x1="12" y1="19" x2="12" y2="5" /><polyline points="5 12 12 5 19 12" /></IconBase>,
            ArrowDown: (props) => <IconBase {...props}><line x1="12" y1="5" x2="12" y2="19" /><polyline points="19 12 12 19 5 12" /></IconBase>,
            Newspaper: (props) => <IconBase {...props}><path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2" /><path d="M18 14h-8" /><path d="M15 18h-5" /><path d="M10 6h8v4h-8V6Z" /></IconBase>,
            Sparkles: (props) => <IconBase {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" /></IconBase>,
            ExternalLink: (props) => <IconBase {...props}><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" /><polyline points="15 3 21 3 21 9" /><line x1="10" y1="14" x2="21" y2="3" /></IconBase>,
            Globe: (props) => <IconBase {...props}><circle cx="12" cy="12" r="10" /><line x1="2" y1="12" x2="22" y2="12" /><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" /></IconBase>,
            Activity: (props) => <IconBase {...props}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12" /></IconBase>,
            BellRing: (props) => <IconBase {...props}><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9" /><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0" /><path d="M4 2C2.8 3.7 2 5.7 2 8" /><path d="M22 8c0-2.3-.8-4.3-2-6" /></IconBase>,
            BellOff: (props) => <IconBase {...props}><path d="M8.7 3A6 6 0 0 1 18 8a21.3 21.3 0 0 0 .6 5" /><path d="M17 17H3s3-2 3-9a4.67 4.67 0 0 1 .3-1.7" /><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0" /><path d="M2 2l20 20" /></IconBase>,
            LogOut: (props) => <IconBase {...props}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" /><polyline points="16 17 21 12 16 7" /><line x1="21" y1="12" x2="9" y2="12" /></IconBase>,
            User: (props) => <IconBase {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></IconBase>,
            Lock: (props) => <IconBase {...props}><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></IconBase>
        };
        const { Bell, TrendingUp, AlertTriangle, Info, RefreshCw, Smartphone, ArrowUp, ArrowDown, Newspaper, Sparkles, ExternalLink, Globe, Activity, BellRing, BellOff, LogOut, User, Lock } = Icons;

        // --- é€šç”¨ Proxy è«‹æ±‚å·¥å…· (å–ä»£ corsproxy.io) ---
        // ä½¿ç”¨ api.allorigins.win ä½œç‚ºæ›¿ä»£æ–¹æ¡ˆï¼Œè§£æ±º Yahoo/Google News å°é–å•é¡Œ
        const fetchWithProxy = async (targetUrl) => {
            const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}`;
            const response = await fetch(proxyUrl);
            if (!response.ok) throw new Error("Proxy Network Error");
            const data = await response.json();
            if (!data.contents) throw new Error("Proxy Empty Response");
            // å˜—è©¦è§£æ JSONï¼Œå¦‚æœæ˜¯ XML/HTML å‰‡å›å‚³å­—ä¸²
            try { return JSON.parse(data.contents); } catch (e) { return data.contents; }
        };

        const formatPrice = (price) => {
            if (price === null || price === undefined) return 'N/A';
            if (price < 1) return price.toLocaleString(undefined, { maximumFractionDigits: 8 });
            return price.toLocaleString(undefined, { maximumFractionDigits: 2 });
        };

        // --- Gemini API (ä½¿ç”¨ Placeholder) ---
        const fetchGeminiAdvice = async (prompt) => {
            let apiKey = GEMINI_API_KEY;
            // æª¢æŸ¥æ˜¯å¦å¾ window æ³¨å…¥ (æœ¬åœ°é–‹ç™¼ç”¨)
            if (typeof window !== 'undefined' && window.GEMINI_API_KEY && !window.GEMINI_API_KEY.includes('PLACEHOLDER')) {
                apiKey = window.GEMINI_API_KEY;
            }
            if (!apiKey || apiKey.includes('PLACEHOLDER')) return `âš ï¸ ç³»çµ±æœªè¨­å®š API Key (è«‹æª¢æŸ¥ GitHub Secrets)`;
            
            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Gemini API Error:", error);
                return "âš ï¸ AI æš«æ™‚ç„¡æ³•æä¾›å»ºè­°ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
            }
        };

        // --- Auth Component ---
        const AuthComponent = ({ user, setUser, isPremium }) => {
            const [localLoading, setLocalLoading] = useState(false);
            const [showLoginModal, setShowLoginModal] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isSignUp, setIsSignUp] = useState(false);
            const [msg, setMsg] = useState(null);

            const handleLogin = async (e) => {
                e.preventDefault();
                if (!supabase) { alert("ç„¡æ³•é€£ç·šåˆ°è³‡æ–™åº« (Secrets æœªæ³¨å…¥)"); return; }
                setLocalLoading(true);
                setMsg(null);
                try {
                    const { data, error } = isSignUp
                        ? await supabase.auth.signUp({ email, password })
                        : await supabase.auth.signInWithPassword({ email, password });
                    if (error) throw error;
                    if (isSignUp && !data.session) { setMsg("è¨»å†ŠæˆåŠŸï¼è«‹æª¢æŸ¥ä¿¡ç®±é©—è­‰ä¿¡ã€‚"); }
                    else if (data.session) { setUser(data.user); setShowLoginModal(false); }
                } catch (error) { setMsg(error.message); } finally { setLocalLoading(false); }
            };

            const handleGoogleLogin = async () => {
                if (!supabase) return;
                const { error } = await supabase.auth.signInWithOAuth({ provider: 'google', options: { redirectTo: window.location.href.split('#')[0] } });
                if (error) setMsg(error.message);
            };

            const handleLogout = async () => { if (!supabase) return; await supabase.auth.signOut(); setUser(null); window.location.reload(); };

            if (user) {
                const avatarUrl = user.user_metadata?.avatar_url || user.user_metadata?.picture;
                return (
                    <div className="flex items-center gap-3 bg-slate-800 py-1.5 px-3 rounded-full border border-slate-700">
                        <div className="flex items-center gap-2">
                            {avatarUrl ? <img src={avatarUrl} alt="User" className="w-6 h-6 rounded-full border border-slate-600" /> : <div className="bg-blue-600 rounded-full p-1"><User size={14} /></div>}
                            <span className="text-xs font-medium text-slate-300 hidden md:block">{user.email.split('@')[0]}</span>
                        </div>
                        {isPremium ? (
                            <button onClick={() => window.open(LEMON_PORTAL_URL, '_blank')} className="text-xs bg-slate-700 hover:bg-slate-600 text-amber-500 font-bold px-2 py-1 rounded transition-colors">ç®¡ç†</button>
                        ) : (
                            <button onClick={() => window.open(`${LEMON_CHECKOUT_URL}?checkout[email]=${encodeURIComponent(user.email)}`, '_blank')} className="text-xs bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-400 text-white font-bold px-2 py-1 rounded flex items-center gap-1"><Sparkles size={10} /> å‡ç´š</button>
                        )}
                        <button onClick={handleLogout} className="text-slate-400 hover:text-red-400 ml-1"><LogOut size={16} /></button>
                    </div>
                );
            }

            return (
                <>
                    <button onClick={() => setShowLoginModal(true)} className="flex items-center gap-2 px-4 py-1.5 bg-indigo-600 hover:bg-indigo-500 text-white rounded-full text-sm font-bold shadow-lg"><User size={16} /> ç™»å…¥</button>
                    {showLoginModal && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] backdrop-blur-sm p-4">
                            <div className="bg-slate-900 p-6 rounded-2xl border border-slate-700 shadow-2xl max-w-sm w-full relative">
                                <button onClick={() => setShowLoginModal(false)} className="absolute top-4 right-4 text-slate-500 hover:text-white">âœ•</button>
                                <h3 className="text-xl font-bold text-white mb-6 text-center">{isSignUp ? 'è¨»å†Šå¸³è™Ÿ' : 'æ­¡è¿å›ä¾†'}</h3>
                                <form onSubmit={handleLogin} className="space-y-4">
                                    <div><label className="block text-xs text-slate-400 mb-1">Email</label><input type="email" required value={email} onChange={e => setEmail(e.target.value)} className="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white" /></div>
                                    <div><label className="block text-xs text-slate-400 mb-1">Password</label><input type="password" required minLength={6} value={password} onChange={e => setPassword(e.target.value)} className="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white" /></div>
                                    {msg && <div className="text-red-400 text-xs text-center">{msg}</div>}
                                    <button type="submit" disabled={localLoading} className="w-full py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg font-bold disabled:opacity-50">{localLoading ? 'è™•ç†ä¸­...' : (isSignUp ? 'è¨»å†Š' : 'ç™»å…¥')}</button>
                                </form>
                                <div className="mt-4 flex items-center gap-2"><div className="h-px bg-slate-800 flex-1"></div><span className="text-xs text-slate-500">or</span><div className="h-px bg-slate-800 flex-1"></div></div>
                                <button onClick={handleGoogleLogin} className="mt-4 w-full py-2 bg-white text-slate-900 rounded-lg font-bold hover:bg-slate-200 flex items-center justify-center gap-2">Google ç™»å…¥</button>
                                <div className="mt-6 text-center"><button onClick={() => { setIsSignUp(!isSignUp); setMsg(null); }} className="text-xs text-slate-400 hover:text-white underline">{isSignUp ? 'å·²æœ‰å¸³è™Ÿï¼Ÿç™»å…¥' : 'æ²’æœ‰å¸³è™Ÿï¼Ÿè¨»å†Š'}</button></div>
                            </div>
                        </div>
                    )}
                </>
            );
        };

        // --- Common Components ---
        const AIAdviceBlock = ({ marketData, assetName, priceStats, isLocked }) => {
            const [advice, setAdvice] = useState(null);
            const [loading, setLoading] = useState(false);
            const [started, setStarted] = useState(false);

            const handleAnalyze = () => {
                if (!marketData) return;
                setStarted(true);
                setLoading(true);
                const priceInfo = priceStats ? `è³‡ç”¢æ•¸æ“š: ç•¶å‰åƒ¹æ ¼: $${formatPrice(priceStats.current)}, è¿‘ä¸€å¹´æœ€é«˜: $${formatPrice(priceStats.high)}, è¿‘ä¸€å¹´æœ€ä½: $${formatPrice(priceStats.low)}` : '';
                const prompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­æŠ•è³‡é¡§å•ã€‚æ ¹æ“šä»¥ä¸‹ ${assetName} æ•¸æ“šï¼Œæä¾› 50 å­—ä»¥å…§ç¹é«”ä¸­æ–‡ DCA å»ºè­°ã€‚åˆ¤æ–·åƒ¹æ ¼å¸å¼•åŠ›ã€‚æ¥µåº¦ææ‡¼å»ºè­°å¼·åŠ›è²·å…¥ï¼Œææ‡¼å»ºè­°åˆ†æ‰¹è²·å…¥ï¼Œä¸­ç«‹è§€æœ›ï¼Œè²ªå©ªæ­¢ç›ˆã€‚\næ•¸æ“š: ${marketData}\n${priceInfo}`;
                fetchGeminiAdvice(prompt).then(text => { setAdvice(text); setLoading(false); });
            };

            if (!started) return (
                <div className="mt-4 text-center">
                    <button onClick={isLocked ? () => { } : handleAnalyze} disabled={isLocked} className={`px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 mx-auto shadow-lg ${isLocked ? 'bg-slate-700 text-slate-400 cursor-not-allowed' : 'bg-indigo-600 text-white'}`}>
                        {isLocked ? <Lock size={16} /> : <Sparkles size={16} />} {isLocked ? 'è©¢å• AI (Pro)' : 'è©¢å• AI æŠ•è³‡é¡§å•'}
                    </button>
                    {isLocked && <p className="text-xs text-amber-500 mt-2 font-bold">å‡ç´š Premium è§£é– AI</p>}
                </div>
            );
            if (loading) return <div className="mt-4 p-4 bg-slate-800/50 rounded-xl animate-pulse text-slate-400 text-sm flex gap-2"><RefreshCw className="animate-spin" /> AI åˆ†æä¸­...</div>;
            return (
                <div className="mt-4 p-4 bg-gradient-to-r from-slate-800 to-slate-900 rounded-xl border border-indigo-500/30 relative overflow-hidden">
                    <div className="absolute top-0 left-0 w-1 h-full bg-indigo-500"></div>
                    <div className="flex justify-between items-start mb-3"><h4 className="text-indigo-400 font-bold text-sm flex items-center gap-2">ğŸ¤– AI å»ºè­°</h4><button onClick={() => { setAdvice(null); setStarted(false); }} className="text-slate-600 hover:text-slate-400"><RefreshCw size={14} /></button></div>
                    <p className="text-slate-300 text-sm leading-relaxed">{advice}</p>
                </div>
            );
        };

        const NewsAIAnalysis = ({ newsItems, isLocked }) => {
            const [summary, setSummary] = useState(null);
            const [loading, setLoading] = useState(false);
            const [started, setStarted] = useState(false);
            const handleAnalyze = () => {
                if (!newsItems.length) return;
                setStarted(true); setLoading(true);
                const titles = newsItems.map(n => n.title).join("\n");
                fetchGeminiAdvice(`ç¸½çµä»¥ä¸‹è²¡ç¶“æ–°èæ¨™é¡Œç‚º 50 å­—ç¹é«”ä¸­æ–‡é‡é»ï¼ŒåŒ…å« 2-3 å€‹ä¸»é¡Œï¼š\n${titles}`).then(text => { setSummary(text); setLoading(false); });
            };
            if (!started) return <div className="mb-6 text-center"><button onClick={handleAnalyze} disabled={isLocked} className={`px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 mx-auto shadow-lg ${isLocked ? 'bg-slate-700 text-slate-400 cursor-not-allowed' : 'bg-blue-600 text-white'}`}>{isLocked ? <Lock size={16} /> : <Newspaper size={16} />} AI åˆ†ææ–°èé‡é»</button>{isLocked && <p className="text-xs text-amber-500 mt-2 font-bold">å‡ç´š Premium è§£é–</p>}</div>;
            if (loading) return <div className="mb-6 p-4 bg-slate-800/50 rounded-xl animate-pulse text-slate-400 text-sm flex gap-2"><RefreshCw className="animate-spin" /> AI é–±è®€ä¸­...</div>;
            return <div className="mb-6 p-4 bg-gradient-to-r from-slate-800 to-slate-900 rounded-xl border border-blue-500/30 relative overflow-hidden"><div className="absolute top-0 left-0 w-1 h-full bg-blue-500"></div><div className="flex justify-between items-start mb-2"><h4 className="text-blue-400 font-bold text-sm flex items-center gap-2">ğŸ“° ä»Šæ—¥é‡é»</h4><button onClick={() => { setSummary(null); setStarted(false); }} className="text-slate-600 hover:text-slate-400"><RefreshCw size={14} /></button></div><p className="text-slate-300 text-sm leading-relaxed">{summary}</p></div>;
        };

        const FearGreedGauge = ({ fngValue, classification }) => {
            const angle = Math.min(180, Math.max(0, (fngValue / 100) * 180));
            const segments = [{ s: 180, e: 135, c: '#EA3943' }, { s: 135, e: 100.8, c: '#EA8C00' }, { s: 100.8, e: 81, c: '#F3D42F' }, { s: 81, e: 46.8, c: '#93D900' }, { s: 46.8, e: 0, c: '#16C784' }];
            const getCoords = (deg) => ({ x: 72 + 59 * Math.cos(deg * Math.PI / 180), y: 79 - 59 * Math.sin(deg * Math.PI / 180) });
            const ind = getCoords(180 - angle);
            return (
                <div className="relative w-full max-w-[200px] mx-auto flex flex-col items-center">
                    <svg className="w-full h-auto" viewBox="0 0 144 89">
                        <g>{segments.map((seg, i) => { const start = getCoords(seg.s); const end = getCoords(seg.e); return <path key={i} d={`M ${start.x} ${start.y} A 59 59 0 0 1 ${end.x} ${end.y}`} fill="none" stroke={seg.c} strokeWidth="10" /> })}</g>
                        <circle cx={ind.x} cy={ind.y} r="7" fill="none" stroke="#d1d5db" strokeWidth="4" /><circle cx={ind.x} cy={ind.y} r="5" fill="white" />
                        <text x="72" y="51" textAnchor="middle" className="fill-white font-black" style={{ fontSize: '28px' }}>{fngValue}</text>
                        <text x="72" y="82" textAnchor="middle" className="fill-slate-400 font-medium" style={{ fontSize: '16px' }}>{classification}</text>
                    </svg>
                </div>
            );
        };

        const NewsSummary = ({ news }) => (
            <div className="bg-gradient-to-br from-slate-800 to-slate-900 p-6 rounded-2xl border border-slate-700 shadow-xl mb-6 relative overflow-hidden">
                <div className="absolute top-0 right-0 w-64 h-64 bg-blue-500/10 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>
                <h3 className="text-lg font-bold text-white flex items-center gap-2 mb-4 z-10 relative"><Sparkles className="text-yellow-400" size={20} /> å¸‚å ´å¿«è¨Š</h3>
                <div className="relative z-10 space-y-3">{news.slice(0, 3).map((item, i) => <div key={i} className="flex gap-3 items-start"><span className="text-blue-500 font-bold text-sm mt-0.5">{i + 1}.</span><a href={item.link} target="_blank" className="text-slate-300 text-sm hover:text-blue-400 transition-colors line-clamp-2">{item.title}</a></div>)}</div>
            </div>
        );

        const NewsSection = ({ news, loading, error }) => {
            if (loading) return <div className="flex justify-center py-12"><RefreshCw className="animate-spin text-slate-500" size={24} /></div>;
            if (error) return <div className="text-center py-8 text-red-400 text-sm">ç„¡æ³•è¼‰å…¥æ–°è: {error}</div>;
            return (
                <div className="grid grid-cols-1 gap-3">
                    {news.slice(0, 6).map((item, i) => (
                        <a key={i} href={item.link} target="_blank" className="group bg-slate-900 border border-slate-800 rounded-xl overflow-hidden hover:border-slate-600 transition-all flex h-24 sm:h-28">
                            <div className="p-3 sm:p-4 flex flex-col justify-between flex-1 min-w-0"><h4 className="font-bold text-slate-200 text-sm sm:text-base line-clamp-2 group-hover:text-blue-400">{item.title}</h4><div className="flex justify-between text-xs text-slate-500 mt-1"><span>{new Date(item.pubDate).toLocaleDateString()}</span><span className="flex items-center gap-1 group-hover:text-blue-400">é–±è®€å…¨æ–‡ <ExternalLink size={12} /></span></div></div>
                            {item.thumbnail && <div className="w-24 sm:w-32 h-full shrink-0 bg-slate-800"><img src={item.thumbnail} alt="" className="w-full h-full object-cover group-hover:scale-105 transition-transform" onError={(e) => e.currentTarget.parentElement.style.display = 'none'} /></div>}
                        </a>
                    ))}
                </div>
            );
        };

        // --- Charts ---
        const ChartComponent = ({ data, options }) => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);
            useEffect(() => {
                if (!chartRef.current) return;
                if (chartInstance.current) chartInstance.current.destroy();
                const ctx = chartRef.current.getContext('2d');
                chartInstance.current = new Chart(ctx, { type: 'line', data, options, plugins: [{ id: 'crosshair', afterDatasetsDraw: (chart) => { if (chart.tooltip?._active?.length) { const { x, y } = chart.tooltip._active[0].element; const ctx = chart.ctx; ctx.save(); ctx.beginPath(); ctx.setLineDash([5, 5]); ctx.lineWidth = 1; ctx.strokeStyle = 'rgba(255,255,255,0.4)'; ctx.moveTo(x, chart.scales.y.top); ctx.lineTo(x, chart.scales.y.bottom); ctx.moveTo(chart.scales.x.left, y); ctx.lineTo(chart.scales.x.right, y); ctx.stroke(); ctx.restore(); } } }] });
                return () => { if (chartInstance.current) chartInstance.current.destroy(); };
            }, [data, options]);
            return <canvas ref={chartRef} />;
        };

        const SentimentScarcityBar = ({ data, title }) => {
            if (!data?.length) return null;
            const total = data.length;
            const extremeFear = data.filter(v => v <= 25).length, fear = data.filter(v => v > 25 && v <= 44).length, other = total - extremeFear - fear;
            return (
                <div className="mt-4 mb-1">
                    <div className="flex justify-between items-end mb-1"><h4 className="text-xs font-bold text-slate-400">{title}</h4><div className="text-[10px] text-slate-500"><span className="text-red-400 font-bold">{extremeFear}å¤©</span> æ¥µåº¦ææ‡¼ â€¢ <span className="text-orange-400 font-bold ml-1">{fear}å¤©</span> ææ‡¼</div></div>
                    <div className="w-full h-2.5 bg-slate-800 rounded-full overflow-hidden flex"><div style={{ width: `${(extremeFear / total) * 100}%` }} className="h-full bg-red-500" /><div style={{ width: `${(fear / total) * 100}%` }} className="h-full bg-orange-500" /><div style={{ width: `${(other / total) * 100}%` }} className="h-full bg-blue-500/30" /></div>
                </div>
            );
        };

        const IndexPriceCard = ({ name, data, suggestion }) => {
            if (!data) return <div className="animate-pulse bg-slate-800 h-32 rounded-xl"></div>;
            const isPos = data.change >= 0;
            return (
                <div className="bg-slate-800 p-4 rounded-xl border border-slate-700">
                    <div className="flex justify-between mb-2"><div><h3 className="text-slate-400 text-sm font-medium flex items-center">{name} {suggestion?.action.includes("è²·") && <span className="ml-2 px-2 py-0.5 text-xs bg-green-500/20 text-green-400 rounded">Buy</span>}</h3><div className="text-2xl font-bold text-slate-100 mt-1">{formatPrice(data.price)}</div></div><div className={`text-right ${isPos ? 'text-green-400' : 'text-red-400'}`}><div className="text-sm font-bold flex justify-end items-center">{isPos ? <ArrowUp size={16} /> : <ArrowDown size={16} />} {Math.abs(data.change).toFixed(2)}</div><div className="text-xs font-medium">{isPos ? '+' : ''}{data.changePercent.toFixed(2)}%</div></div></div>
                </div>
            );
        };

        const SymbolSearch = ({ symbol, onSearch, placeholder, isLocked }) => {
            const [input, setInput] = useState(symbol);
            useEffect(() => setInput(symbol), [symbol]);
            return (
                <div className="flex gap-2 mb-4 relative"><div className="relative flex-1"><input type="text" value={input} onChange={e => setInput(e.target.value.toUpperCase())} onKeyDown={e => !isLocked && e.key === 'Enter' && onSearch(input)} disabled={isLocked} className={`w-full bg-slate-800 text-white px-4 py-2 rounded-lg border focus:border-blue-500 outline-none font-mono ${isLocked ? 'border-slate-700 opacity-50' : 'border-slate-700'}`} placeholder={placeholder} />{isLocked && <div className="absolute inset-0 flex items-end justify-end pr-4 pointer-events-none"><Lock size={16} className="text-slate-500" /></div>}</div><button onClick={() => !isLocked && onSearch(input)} disabled={isLocked} className={`px-4 py-2 rounded-lg flex items-center gap-2 ${isLocked ? 'bg-slate-800 text-slate-500' : 'bg-blue-600 text-white'}`}>{isLocked ? 'é–å®š' : <><RefreshCw size={16} /> æœå°‹</>}</button></div>
            );
        };

        const TimeRangeSelector = ({ range, onRangeChange }) => (
            <div className="flex bg-slate-800 rounded-lg p-1 border border-slate-700">{['1M', '6M', '1Y', 'ALL'].map(r => <button key={r} onClick={() => onRangeChange(r)} className={`px-3 py-1 text-xs font-medium rounded-md transition-all ${range === r ? 'bg-blue-600 text-white shadow-md' : 'text-slate-400 hover:bg-slate-700'}`}>{r}</button>)}</div>
        );

        // --- Universal Chart Modal (Shared) ---
        const ChartModal = ({ symbol, type, onClose }) => {
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [chartData, setChartData] = useState([]);
            const [stats, setStats] = useState(null);

            useEffect(() => {
                const loadData = async () => {
                    setLoading(true); setError(null);
                    try {
                        let mergedData = [];
                        let currentStats = {};
                        if (type === 'US') {
                            const fngJson = await fetchWithProxy('https://production.dataviz.cnn.io/index/fearandgreed/graphdata');
                            const fngMap = new Map();
                            fngJson.fear_and_greed_historical?.data?.forEach(item => fngMap.set(new Date(item.x).toISOString().split('T')[0], Math.round(item.y)));
                            
                            const yfUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1d&range=1y`;
                            const yfJson = await fetchWithProxy(yfUrl);
                            const result = yfJson.chart.result[0];
                            
                            mergedData = result.timestamp.map((t, i) => {
                                const date = new Date(t * 1000).toISOString().split('T')[0];
                                const price = result.indicators.quote[0].close[i];
                                if (!price) return null;
                                let fng = fngMap.get(date) || 50;
                                return { date, price, fng, classification: fng <= 25 ? 'Extreme Fear' : fng <= 45 ? 'Fear' : 'Neutral' };
                            }).filter(d => d);
                            currentStats = { value: Math.round(fngJson.fear_and_greed.score), label: fngJson.fear_and_greed.rating };
                        } else if (type === 'CRYPTO') {
                            const map = { 'BTC': 'bitcoin', 'ETH': 'ethereum', 'SOL': 'solana', 'DOGE': 'dogecoin' };
                            const id = map[symbol.toUpperCase()] || symbol.toLowerCase();
                            const fngRes = await fetch('https://api.alternative.me/fng/?limit=365');
                            const fngJson = await fngRes.json();
                            const fngMap = new Map();
                            fngJson.data.forEach(item => fngMap.set(new Date(item.timestamp * 1000).toISOString().split('T')[0], parseInt(item.value)));
                            
                            const cgRes = await fetch(`https://api.coingecko.com/api/v3/coins/${id}/market_chart?vs_currency=usd&days=365&interval=daily`);
                            if(!cgRes.ok) throw new Error("CoinGecko Error");
                            const cgJson = await cgRes.json();
                            mergedData = cgJson.prices.map(([ts, price]) => {
                                const date = new Date(ts).toISOString().split('T')[0];
                                const fng = fngMap.get(date) || 50;
                                return { date, price, fng, classification: fng <= 25 ? 'Extreme Fear' : fng <= 45 ? 'Fear' : 'Neutral' };
                            });
                            currentStats = { value: fngJson.data[0].value, label: fngJson.data[0].value_classification };
                        } else if (type === 'TW') {
                            const yfSymbol = symbol.includes('.') ? symbol : `${symbol}.TW`;
                            const yfUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${yfSymbol}?interval=1d&range=1y`;
                            const yfJson = await fetchWithProxy(yfUrl);
                            const result = yfJson.chart.result[0];
                            const cleanData = result.timestamp.map((t, i) => ({ price: result.indicators.quote[0].close[i], date: new Date(t * 1000).toISOString().split('T')[0] })).filter(d => d.price);
                            // RSI Calc (Simplified)
                            const rsiData = []; let avgGain = 0, avgLoss = 0;
                            for (let i = 1; i <= 14; i++) { const chg = cleanData[i].price - cleanData[i - 1].price; if (chg > 0) avgGain += chg; else avgLoss -= chg; }
                            avgGain /= 14; avgLoss /= 14;
                            for (let i = 15; i < cleanData.length; i++) {
                                const chg = cleanData[i].price - cleanData[i - 1].price;
                                avgGain = ((avgGain * 13) + (chg > 0 ? chg : 0)) / 14;
                                avgLoss = ((avgLoss * 13) + (chg < 0 ? -chg : 0)) / 14;
                                let rsi = 100 - (100 / (1 + (avgGain / avgLoss)));
                                rsiData.push({ ...cleanData[i], fng: Math.round(rsi), classification: rsi <= 30 ? 'Oversold' : rsi >= 70 ? 'Overbought' : 'Neutral' });
                            }
                            mergedData = rsiData;
                            const last = mergedData[mergedData.length - 1];
                            currentStats = { value: last.fng, label: last.classification };
                        }
                        setChartData(mergedData); setStats(currentStats);
                    } catch (e) { setError(e.message); } finally { setLoading(false); }
                };
                loadData();
            }, [symbol, type]);

            return (
                <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[60] backdrop-blur-sm p-4" onClick={onClose}>
                    <div className="bg-slate-900 w-full max-w-3xl rounded-2xl border border-slate-700 shadow-2xl relative overflow-hidden flex flex-col max-h-[90vh]" onClick={e => e.stopPropagation()}>
                        <div className="p-4 border-b border-slate-800 flex justify-between items-center"><h3 className="text-xl font-bold text-white flex gap-2"><TrendingUp size={20} className="text-blue-500"/>{symbol} åˆ†æ</h3><button onClick={onClose} className="p-2 hover:bg-slate-800 text-slate-400">âœ•</button></div>
                        <div className="p-6 overflow-y-auto">
                            {loading ? <div className="h-64 flex justify-center items-center gap-2"><RefreshCw className="animate-spin" />è¼‰å…¥ä¸­...</div> : error ? <div className="h-64 flex justify-center items-center text-red-400 gap-2"><AlertTriangle />{error}</div> : (
                                <div className="space-y-6">
                                    <div className="h-[350px] w-full bg-slate-950/50 rounded-xl p-2"><UniversalFNGChart data={chartData} symbol={symbol} /></div>
                                    {stats && <div className="grid grid-cols-2 gap-4"><div className="bg-slate-800 p-4 rounded-xl border border-slate-700"><div className="text-slate-400 text-xs">æŒ‡æ¨™</div><div className="text-2xl font-bold text-white">{stats.value} <span className="text-sm font-normal text-slate-400">/ 100</span></div><div className={`text-sm font-bold ${stats.value <= 40 ? 'text-red-400' : 'text-blue-400'}`}>{stats.label}</div></div><div className="bg-slate-800 p-4 rounded-xl border border-slate-700"><div className="text-slate-400 text-xs">å»ºè­°</div><div className="text-lg font-bold text-white">{stats.value <= 30 ? 'ğŸŸ¢ å¼·åŠ›è²·å…¥' : stats.value <= 50 ? 'ğŸŸ¡ åˆ†æ‰¹è²·å…¥' : 'âšª è§€æœ›'}</div></div></div>}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const UniversalFNGChart = ({ data, symbol }) => {
            if (!data?.length) return null;
            const chartData = {
                labels: data.map(d => d.date),
                datasets: [{
                    label: `${symbol} åƒ¹æ ¼`, data: data.map(d => d.price),
                    borderColor: '#3b82f6', backgroundColor: (ctx) => { const g = ctx.chart.ctx.createLinearGradient(0, 0, 0, 400); g.addColorStop(0, 'rgba(59,130,246,0.5)'); g.addColorStop(1, 'rgba(59,130,246,0)'); return g; },
                    fill: true, tension: 0.4,
                    pointBackgroundColor: data.map(d => d.fng <= 25 ? '#ef4444' : d.fng <= 45 ? '#f97316' : 'rgba(0,0,0,0)'),
                    pointBorderColor: data.map(d => d.fng <= 25 ? '#ef4444' : d.fng <= 45 ? '#f97316' : 'rgba(0,0,0,0)'),
                    pointRadius: data.map(d => d.fng <= 45 ? 3 : 0)
                }]
            };
            const options = { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { display: false }, tooltip: { backgroundColor: 'rgba(15,23,42,0.9)', callbacks: { label: (c) => [`$${formatPrice(c.parsed.y)}`, `æŒ‡æ¨™: ${data[c.dataIndex].fng}`, data[c.dataIndex].fng <= 40 ? 'ğŸ”´ è²·å…¥' : 'âšª è§€æœ›'] } } }, scales: { x: { display: false }, y: { grid: { color: '#334155' } } } };
            return <ChartComponent data={chartData} options={options} />;
        };

        // --- Crypto Dashboard (Fix: CoinGecko) ---
        const CryptoDashboard = ({ notificationsEnabled, toggleNotifications, userInfo, onUpdateWatchlist }) => {
            const [selectedCoin, setSelectedCoin] = useState('bitcoin');
            const [timeRange, setTimeRange] = useState('1Y');
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [historicalData, setHistoricalData] = useState([]);
            const [fullData, setFullData] = useState([]);
            const [currentFNG, setCurrentFNG] = useState(null);
            const [prices, setPrices] = useState(null);
            const [news, setNews] = useState([]);

            const fetchCurrentPrices = async (ids = ['bitcoin', 'ethereum']) => {
                try {
                    const queryIds = ids.map(id => id.toLowerCase()).join(',');
                    const response = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${queryIds}&vs_currencies=usd&include_24hr_change=true`);
                    if (response.ok) {
                        const data = await response.json();
                        const newPrices = {};
                        Object.keys(data).forEach(key => { newPrices[key] = { usd: data[key].usd, usd_24h_change: data[key].usd_24h_change, symbol: key.toUpperCase() }; });
                        setPrices(prev => ({ ...prev, ...newPrices }));
                    }
                } catch (e) { console.warn("CG Price Error:", e); }
            };

            const fetchData = async () => {
                setLoading(true); setError(null);
                const slugs = ['bitcoin', 'ethereum'];
                if (!slugs.includes(selectedCoin)) slugs.push(selectedCoin);
                fetchCurrentPrices(slugs);

                try {
                    const fngRes = await fetch('https://api.alternative.me/fng/?limit=365');
                    const fngJson = await fngRes.json();
                    const fngMap = new Map();
                    fngJson.data.forEach(item => fngMap.set(new Date(item.timestamp * 1000).toISOString().split('T')[0], { value: parseInt(item.value), classification: item.value_classification }));
                    setCurrentFNG(fngJson.data[0]);

                    const coinRes = await fetch(`https://api.coingecko.com/api/v3/coins/${selectedCoin}/market_chart?vs_currency=usd&days=365&interval=daily`);
                    if (coinRes.status === 404) {
                        const sRes = await fetch(`https://api.coingecko.com/api/v3/search?query=${selectedCoin}`);
                        const sData = await sRes.json();
                        if (sData.coins?.length) { setSelectedCoin(sData.coins[0].id); return; }
                    }
                    if (!coinRes.ok) throw new Error("CoinGecko API Error");
                    const coinJson = await coinRes.json();
                    const merged = coinJson.prices.map(([ts, price]) => {
                        const date = new Date(ts).toISOString().split('T')[0];
                        const fng = fngMap.get(date) || { value: 50, classification: 'Neutral' };
                        return { date, price, fng: fng.value, classification: fng.classification };
                    });
                    setFullData(merged);
                } catch (e) { setError(e.message); } finally { setLoading(false); }
            };

            useEffect(() => { fetchData(); }, [selectedCoin]);
            useEffect(() => {
                if (!fullData.length) return;
                const now = new Date(); let filterDate = new Date(); let isAll = false;
                if (timeRange === '1M') filterDate.setMonth(now.getMonth() - 1);
                else if (timeRange === '6M') filterDate.setMonth(now.getMonth() - 6);
                else isAll = true;
                setHistoricalData(fullData.filter(d => isAll || new Date(d.date) >= filterDate));
            }, [timeRange, fullData]);

            // News (RSS2JSON is stable)
            useEffect(() => {
                fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent('https://news.google.com/rss/search?q=åŠ å¯†è²¨å¹£&hl=zh-TW&gl=TW&ceid=TW:zh-Hant')}`)
                    .then(r => r.json()).then(d => d.status === 'ok' && setNews(d.items));
            }, []);

            const toggleWatchlist = () => { onUpdateWatchlist(userInfo.watchlist.includes(selectedCoin) ? userInfo.watchlist.filter(s => s !== selectedCoin) : [...userInfo.watchlist, selectedCoin]); };
            
            return (
                <div className="space-y-6">
                    <SymbolSearch symbol={selectedCoin} onSearch={setSelectedCoin} placeholder="è¼¸å…¥å¹£ç¨® (e.g. solana)" isLocked={!userInfo.isPremium} />
                    <div className="flex gap-4 w-full flex-wrap">
                        {['bitcoin', 'ethereum'].map(c => (
                            <div key={c} onClick={() => setSelectedCoin(c)} className={`cursor-pointer flex-1 p-4 rounded-xl border transition-all ${selectedCoin === c ? 'bg-slate-800 border-blue-500 shadow-lg' : 'bg-slate-900/50 border-slate-800'}`}>
                                <div className="flex items-center gap-2 mb-2"><img src={`https://cryptologos.cc/logos/${c === 'bitcoin' ? 'bitcoin-btc' : 'ethereum-eth'}-logo.png`} className="w-6 h-6" /><span className="font-bold text-white uppercase">{c === 'bitcoin' ? 'BTC' : 'ETH'}</span></div>
                                <div className="text-xl font-mono text-white">{prices && prices[c] ? `$${formatPrice(prices[c].usd)}` : 'Loading...'}</div>
                            </div>
                        ))}
                    </div>
                    {loading ? <div className="h-64 flex justify-center items-center"><RefreshCw className="animate-spin" /></div> : error ? <div className="text-red-400 text-center">{error}</div> : (
                        <>
                            <div className="bg-slate-900 p-6 rounded-2xl border border-slate-700 shadow-xl flex flex-col items-center">
                                <h2 className="text-xl font-bold text-slate-200 mb-4">ææ‡¼è²ªå©ªæŒ‡æ•¸</h2>
                                <FearGreedGauge fngValue={currentFNG?.value} classification={currentFNG?.value_classification} />
                                <div className="w-full max-w-2xl mt-4 px-4"><SentimentScarcityBar data={historicalData.map(d => d.fng)} title="æ©Ÿæœƒåˆ†ä½ˆ" /></div>
                            </div>
                            <div className="h-[350px] w-full bg-slate-900 rounded-xl p-2"><UniversalFNGChart data={historicalData} symbol={selectedCoin.toUpperCase()} /></div>
                            <NewsSection news={news} />
                        </>
                    )}
                </div>
            );
        };

        // --- Stock Dashboard (Fix: AllOrigins Proxy) ---
        const StockDashboard = ({ userInfo, onUpdateWatchlist }) => {
            const [selectedSymbol, setSelectedSymbol] = useState('SPY');
            const [timeRange, setTimeRange] = useState('1Y');
            const [stockData, setStockData] = useState(null);
            const [fullData, setFullData] = useState(null);
            const [fngData, setFngData] = useState(null);
            const [fngHistory, setFngHistory] = useState([]);
            const [news, setNews] = useState([]);
            const [indices, setIndices] = useState({});
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            const fetchStockData = async () => {
                setLoading(true); setError(null);
                try {
                    // FNG via Proxy
                    try {
                        const fngJson = await fetchWithProxy('https://production.dataviz.cnn.io/index/fearandgreed/graphdata');
                        setFngData({ value: Math.round(fngJson.fear_and_greed.score), classification: fngJson.fear_and_greed.rating });
                        const fngMap = new Map();
                        fngJson.fear_and_greed_historical.data.forEach(item => fngMap.set(new Date(item.x).toISOString().split('T')[0], Math.round(item.y)));
                        
                        // Yahoo via Proxy
                        const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${selectedSymbol}?interval=1d&range=1y`;
                        const historyJson = await fetchWithProxy(yahooUrl);
                        if (!historyJson.chart?.result) throw new Error("No Data");
                        const result = historyJson.chart.result[0];
                        const prices = result.timestamp.map((t, i) => {
                            const date = new Date(t * 1000).toISOString().split('T')[0];
                            const price = result.indicators.quote[0].close[i];
                            if (!price) return null;
                            const fng = fngMap.get(date) || 50;
                            return { date, price, fng };
                        }).filter(d => d);
                        setFullData(prices);
                        setFngHistory(prices.map(p => ({ y: p.fng })));
                    } catch (e) { console.error(e); }

                    // Indices
                    const fetchIdx = async (s) => { try { const d = await fetchWithProxy(`https://query1.finance.yahoo.com/v8/finance/chart/${s}?interval=1d&range=1d`); const m = d.chart.result[0].meta; return { price: m.regularMarketPrice, change: m.regularMarketPrice - m.chartPreviousClose, changePercent: (m.regularMarketPrice - m.chartPreviousClose) / m.chartPreviousClose * 100 }; } catch { return null; } };
                    Promise.all([fetchIdx('SPY'), fetchIdx('QQQ'), fetchIdx('GLD')]).then(([spy, qqq, gold]) => setIndices({ spy, qqq, gold }));

                    // News
                    fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent('https://search.cnbc.com/rs/search/combinedcms/view.xml?partnerId=wrss01&id=10000664')}`).then(r => r.json()).then(d => d.status === 'ok' && setNews(d.items));

                } catch (e) { setError(e.message); } finally { setLoading(false); }
            };

            useEffect(() => { fetchStockData(); }, [selectedSymbol]);
            useEffect(() => {
                if (!fullData) return;
                const now = new Date(); let filterDate = new Date(); let isAll = false;
                if (timeRange === '1M') filterDate.setMonth(now.getMonth() - 1);
                else if (timeRange === '6M') filterDate.setMonth(now.getMonth() - 6);
                else isAll = true;
                setStockData(fullData.filter(d => isAll || new Date(d.date) >= filterDate));
            }, [timeRange, fullData]);

            const toggleWatchlist = () => { onUpdateWatchlist(userInfo.watchlist.includes(selectedSymbol) ? userInfo.watchlist.filter(s => s !== selectedSymbol) : [...userInfo.watchlist, selectedSymbol]); };

            return (
                <div className="space-y-6">
                    <SymbolSearch symbol={selectedSymbol} onSearch={setSelectedSymbol} isLocked={!userInfo.isPremium} />
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <IndexPriceCard name="S&P 500" symbol="SPY" data={indices.spy} />
                        <IndexPriceCard name="NASDAQ" symbol="QQQ" data={indices.qqq} />
                        <IndexPriceCard name="Gold" symbol="GLD" data={indices.gold} />
                    </div>
                    {loading ? <div className="h-64 flex justify-center items-center"><RefreshCw className="animate-spin" /></div> : (
                        <>
                            <div className="bg-slate-900 p-6 rounded-2xl border border-slate-800 shadow-xl flex flex-col items-center">
                                <h2 className="text-xl font-bold text-slate-200 mb-2">ç¾è‚¡ææ‡¼èˆ‡è²ªå©ª</h2>
                                {fngData && <FearGreedGauge fngValue={fngData.value} classification={fngData.classification} />}
                                <div className="w-full max-w-2xl mt-4 px-4"><SentimentScarcityBar data={fngHistory.map(d => d.y)} title="æ©Ÿæœƒåˆ†ä½ˆ" /></div>
                            </div>
                            <div className="bg-slate-900 p-4 rounded-2xl border border-slate-800 shadow-xl">
                                <div className="flex justify-between items-center mb-4"><h2 className="text-lg font-semibold flex items-center gap-2"><TrendingUp size={18} /> {selectedSymbol} èµ°å‹¢ {onUpdateWatchlist && <button onClick={toggleWatchlist}>{userInfo.watchlist.includes(selectedSymbol) ? 'â˜…' : 'â˜†'}</button>}</h2><TimeRangeSelector range={timeRange} onRangeChange={setTimeRange} /></div>
                                <div className="h-[300px] w-full"><UniversalFNGChart data={stockData} symbol={selectedSymbol} /></div>
                            </div>
                            <NewsSection news={news} />
                        </>
                    )}
                </div>
            );
        };

        // --- Taiwan Dashboard (Fix: AllOrigins Proxy) ---
        const TaiwanDashboard = ({ userInfo, onUpdateWatchlist }) => {
            const [selectedSymbol, setSelectedSymbol] = useState('0050');
            const [timeRange, setTimeRange] = useState('1Y');
            const [rsiData, setRsiData] = useState(null);
            const [indices, setIndices] = useState({});
            const [news, setNews] = useState([]);
            const [loading, setLoading] = useState(true);

            const fetchData = async () => {
                setLoading(true);
                try {
                    const fetchYF = async (s) => { try { const d = await fetchWithProxy(`https://query1.finance.yahoo.com/v8/finance/chart/${s}?interval=1d&range=1d`); const m = d.chart.result[0].meta; return { price: m.regularMarketPrice, change: m.regularMarketPrice - m.chartPreviousClose, changePercent: (m.regularMarketPrice - m.chartPreviousClose) / m.chartPreviousClose * 100 }; } catch { return null; } };
                    Promise.all([fetchYF('^TWII'), fetchYF('0050.TW'), fetchYF('0056.TW')]).then(([twii, tw50, tw56]) => setIndices({ twii, tw50, tw56 }));

                    const ySymbol = selectedSymbol.includes('.') ? selectedSymbol : `${selectedSymbol}.TW`;
                    const histData = await fetchWithProxy(`https://query1.finance.yahoo.com/v8/finance/chart/${ySymbol}?interval=1d&range=1y`);
                    const result = histData.chart.result[0];
                    const cleanData = result.timestamp.map((t, i) => ({ price: result.indicators.quote[0].close[i], date: new Date(t * 1000).toISOString().split('T')[0] })).filter(d => d.price);
                    
                    // RSI Calc
                    const rsiArr = []; let avgGain = 0, avgLoss = 0;
                    for (let i = 1; i <= 14; i++) { const chg = cleanData[i].price - cleanData[i - 1].price; if (chg > 0) avgGain += chg; else avgLoss -= chg; }
                    avgGain /= 14; avgLoss /= 14;
                    for (let i = 15; i < cleanData.length; i++) {
                        const chg = cleanData[i].price - cleanData[i - 1].price;
                        avgGain = ((avgGain * 13) + (chg > 0 ? chg : 0)) / 14;
                        avgLoss = ((avgLoss * 13) + (chg < 0 ? -chg : 0)) / 14;
                        let rsi = 100 - (100 / (1 + (avgGain / avgLoss)));
                        rsiArr.push({ ...cleanData[i], fng: Math.round(rsi), classification: rsi <= 30 ? 'Oversold' : rsi >= 70 ? 'Overbought' : 'Neutral' });
                    }
                    setRsiData({ value: rsiArr[rsiArr.length - 1].fng, classification: rsiArr[rsiArr.length - 1].classification, history: rsiArr });

                    // Google News RSS via Proxy
                    const rssUrl = `https://news.google.com/rss/search?q=${selectedSymbol}+è‚¡ç¥¨&hl=zh-TW&gl=TW&ceid=TW:zh-Hant`;
                    const xmlStr = await fetchWithProxy(rssUrl);
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlStr, "text/xml");
                    const items = Array.from(xmlDoc.querySelectorAll("item")).slice(0, 6).map(item => ({
                        title: item.querySelector("title").textContent,
                        link: item.querySelector("link").textContent,
                        pubDate: item.querySelector("pubDate").textContent
                    }));
                    setNews(items);

                } catch (e) { console.error(e); } finally { setLoading(false); }
            };

            useEffect(() => { fetchData(); }, [selectedSymbol]);
            const toggleWatchlist = () => { onUpdateWatchlist(userInfo.watchlist.includes(selectedSymbol) ? userInfo.watchlist.filter(s => s !== selectedSymbol) : [...userInfo.watchlist, selectedSymbol]); };

            return (
                <div className="space-y-6">
                    <SymbolSearch symbol={selectedSymbol} onSearch={setSelectedSymbol} placeholder="ä»£è™Ÿ (e.g. 2330)" isLocked={!userInfo.isPremium} />
                    <div className="grid grid-cols-3 gap-4"><IndexPriceCard name="åŠ æ¬ŠæŒ‡æ•¸" data={indices.twii} /><IndexPriceCard name="0050" data={indices.tw50} /><IndexPriceCard name="0056" data={indices.tw56} /></div>
                    {loading ? <div className="h-64 flex justify-center items-center"><RefreshCw className="animate-spin" /></div> : (
                        <>
                            <div className="bg-slate-900 p-6 rounded-2xl border border-slate-800 shadow-xl flex flex-col items-center">
                                <h2 className="text-xl font-bold text-slate-200">RSI æƒ…ç·’æŒ‡æ¨™</h2>
                                {rsiData && <FearGreedGauge fngValue={rsiData.value} classification={rsiData.classification} />}
                                <div className="w-full max-w-2xl mt-4 px-4"><SentimentScarcityBar data={rsiData?.history.map(d => d.fng) || []} title="RSI åˆ†ä½ˆ" /></div>
                            </div>
                            <div className="bg-slate-900 p-4 rounded-2xl border border-slate-800 shadow-xl">
                                <div className="flex justify-between items-center mb-4"><h2 className="text-lg font-semibold flex items-center gap-2"><TrendingUp size={18} /> {selectedSymbol} èµ°å‹¢ {onUpdateWatchlist && <button onClick={toggleWatchlist}>{userInfo.watchlist.includes(selectedSymbol) ? 'â˜…' : 'â˜†'}</button>}</h2></div>
                                <div className="h-[300px] w-full"><UniversalFNGChart data={rsiData?.history} symbol={selectedSymbol} /></div>
                            </div>
                            <NewsSection news={news} />
                        </>
                    )}
                </div>
            );
        };

        // --- Watchlist Dashboard ---
        const WatchlistDashboard = ({ watchlist, onUpdateWatchlist, isPremium, user }) => {
            const [assetsData, setAssetsData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [selectedChartItem, setSelectedChartItem] = useState(null);

            if (!isPremium) return (
                <div className="flex flex-col items-center justify-center py-20 text-center space-y-6">
                    <div className="bg-slate-800 p-6 rounded-full border border-slate-700 shadow-2xl relative"><Lock size={64} className="text-slate-500" /><div className="absolute -top-2 -right-2 bg-amber-500 text-slate-900 font-bold px-3 py-1 rounded-full text-xs shadow-lg animate-bounce">PRO</div></div>
                    <div><h2 className="text-3xl font-bold text-white mb-2">è§£é–æˆ‘çš„è‡ªé¸å„€è¡¨æ¿</h2><p className="text-slate-400 max-w-md mx-auto">å‡ç´šè‡³ Premium æœƒå“¡ï¼Œå³å¯å»ºç«‹å°ˆå±¬çš„è·¨å¸‚å ´æŠ•è³‡çµ„åˆã€‚</p></div>
                    <button onClick={() => window.open(`${LEMON_CHECKOUT_URL}?checkout[email]=${encodeURIComponent(user.email)}`, '_blank')} className="flex items-center gap-3 px-8 py-4 bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-400 text-white font-bold rounded-2xl shadow-xl hover:scale-105"><Sparkles /> ç«‹å³å‡ç´š Pro</button>
                </div>
            );

            const classifyAsset = (symbol) => {
                if (symbol.toUpperCase().includes('.TW') || /^\d+$/.test(symbol)) return 'TW';
                const cryptos = ['BTC', 'ETH', 'SOL', 'BNB', 'DOGE', 'BITCOIN', 'ETHEREUM', 'SOLANA'];
                if (cryptos.includes(symbol.toUpperCase())) return 'CRYPTO';
                return 'US';
            };

            const calculateDCA = (cur, low, high) => {
                if (!cur || !low || !high) return { action: "N/A", color: "text-slate-500", bg: "bg-slate-800" };
                const pos = (cur - low) / (high - low);
                if (pos < 0.2) return { action: "å¼·åŠ›è²·å…¥", color: "text-green-400", bg: "bg-green-900/30", icon: "ğŸŸ¢" };
                if (pos < 0.4) return { action: "åˆ†æ‰¹è²·å…¥", color: "text-yellow-400", bg: "bg-yellow-900/30", icon: "ğŸŸ¡" };
                if (pos > 0.8) return { action: "è€ƒæ…®æ­¢ç›ˆ", color: "text-red-400", bg: "bg-red-900/30", icon: "ğŸ”´" };
                return { action: "è§€æœ›", color: "text-slate-400", bg: "bg-slate-800", icon: "âšª" };
            };

            const fetchData = async () => {
                if (!watchlist.length) { setAssetsData([]); setLoading(false); return; }
                setLoading(true);
                const promises = watchlist.map(async (symbol) => {
                    const type = classifyAsset(symbol);
                    let data = { symbol, type, price: null, high: null, low: null };
                    try {
                        if (type === 'US' || type === 'TW') {
                            const yfSymbol = type === 'TW' && !symbol.includes('.') ? `${symbol}.TW` : symbol;
                            const yfJson = await fetchWithProxy(`https://query1.finance.yahoo.com/v8/finance/chart/${yfSymbol}?interval=1d&range=1y`);
                            const meta = yfJson.chart.result[0].meta;
                            const closes = yfJson.chart.result[0].indicators.quote[0].close.filter(x => x);
                            data.price = meta.regularMarketPrice;
                            data.changePercent = (data.price - meta.chartPreviousClose) / meta.chartPreviousClose * 100;
                            data.high = Math.max(...closes);
                            data.low = Math.min(...closes);
                        } else {
                            const map = { 'BTC': 'bitcoin', 'ETH': 'ethereum', 'SOL': 'solana', 'DOGE': 'dogecoin' };
                            const id = map[symbol.toUpperCase()] || symbol.toLowerCase();
                            const pRes = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${id}&vs_currencies=usd&include_24hr_change=true`);
                            const pJson = await pRes.json();
                            if (pJson[id]) {
                                data.price = pJson[id].usd;
                                data.changePercent = pJson[id].usd_24h_change;
                                const hRes = await fetch(`https://api.coingecko.com/api/v3/coins/${id}/market_chart?vs_currency=usd&days=365`);
                                const hJson = await hRes.json();
                                const prices = hJson.prices.map(p => p[1]);
                                data.high = Math.max(...prices);
                                data.low = Math.min(...prices);
                            }
                        }
                    } catch (e) { console.error(e); }
                    return data;
                });
                const res = await Promise.all(promises);
                setAssetsData(res);
                setLoading(false);
            };

            useEffect(() => { fetchData(); }, [watchlist]);
            const handleDelete = (s) => onUpdateWatchlist(watchlist.filter(i => i !== s));

            if (loading) return <div className="flex justify-center py-20"><RefreshCw className="animate-spin text-slate-500" size={32} /></div>;
            if (!watchlist.length) return <div className="text-center py-20 text-slate-500"><Sparkles size={48} className="mx-auto mb-4 opacity-50" /><h3 className="text-xl font-bold text-slate-300">æ¸…å–®æ˜¯ç©ºçš„</h3><p className="mt-2 text-sm">è«‹å‰å¾€å„åˆ†é åŠ å…¥è‡ªé¸è‚¡ã€‚</p></div>;

            return (
                <>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {assetsData.map((item) => {
                            const st = calculateDCA(item.price, item.low, item.high);
                            return (
                                <div key={item.symbol} onClick={() => setSelectedChartItem(item)} className="bg-slate-900 rounded-2xl border border-slate-700 p-5 relative group hover:border-blue-500 transition-colors cursor-pointer">
                                    <button onClick={(e) => { e.stopPropagation(); handleDelete(item.symbol); }} className="absolute top-4 right-4 text-slate-600 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity">âœ•</button>
                                    <div className="flex items-center gap-2 mb-4"><span className="text-xs font-bold px-2 py-1 bg-slate-800 rounded text-slate-400">{item.type}</span><h3 className="text-xl font-bold text-white tracking-widest">{item.symbol}</h3></div>
                                    <div className="flex items-baseline gap-2 mb-4"><span className="text-2xl font-mono text-white">${formatPrice(item.price)}</span><span className={`text-sm font-bold ${item.changePercent >= 0 ? 'text-green-400' : 'text-red-400'}`}>{item.changePercent > 0 ? '+' : ''}{item.changePercent?.toFixed(2)}%</span></div>
                                    <div className="grid grid-cols-2 gap-2 text-xs text-slate-400 mb-4 bg-slate-800/50 p-3 rounded-lg"><div><div className="opacity-70">1Y High</div><div className="font-mono text-slate-200">${formatPrice(item.high)}</div></div><div><div className="opacity-70">1Y Low</div><div className="font-mono text-slate-200">${formatPrice(item.low)}</div></div></div>
                                    <div className={`flex items-center justify-between px-3 py-2 rounded-lg ${st.bg} border border-white/5`}><div className="flex items-center gap-2"><span>{st.icon}</span><span className={`font-bold ${st.color}`}>{st.action}</span></div>{item.high && <div className="w-16 h-1.5 bg-slate-700 rounded-full overflow-hidden"><div className={`h-full ${st.color.replace('text-', 'bg-')}`} style={{ width: `${Math.max(0, Math.min(100, ((item.price - item.low) / (item.high - item.low)) * 100))}%` }}></div></div>}</div>
                                </div>
                            );
                        })}
                    </div>
                    {selectedChartItem && <ChartModal symbol={selectedChartItem.symbol} type={selectedChartItem.type} onClose={() => setSelectedChartItem(null)} />}
                </>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('crypto');
            const [user, setUser] = useState(null);
            const [isPremium, setIsPremium] = useState(false);
            const [watchlist, setWatchlist] = useState([]);
            const [loading, setLoading] = useState(true);

            // Notification State
            const [notificationsEnabled, setNotificationsEnabled] = useState(false);
            const [showNotificationDropdown, setShowNotificationDropdown] = useState(false);
            const [notificationHistory, setNotificationHistory] = useState([]);
            const [unreadCount, setUnreadCount] = useState(0);

            useEffect(() => {
                if (!supabase) { setLoading(false); return; }
                supabase.auth.getSession().then(({ data: { session } }) => {
                    if (session) setUser(session.user);
                    setLoading(false);
                });
                const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
                    setUser(session?.user ?? null);
                    setLoading(false);
                });
                return () => subscription.unsubscribe();
            }, []);

            useEffect(() => {
                const fetchProfile = async () => {
                    if (!user || !supabase) { setIsPremium(false); setWatchlist([]); return; }
                    const { data, error } = await supabase.from('user_profiles').select('is_premium, watchlist, notifications').eq('id', user.id).single();
                    if (data) { 
                        setIsPremium(data.is_premium); 
                        setWatchlist(data.watchlist || []);
                        const notifs = Array.isArray(data.notifications) ? data.notifications : [];
                        setNotificationHistory(notifs);
                        setUnreadCount(notifs.filter(n => !n.is_read).length);
                    }
                    else if (error && error.code === 'PGRST116') await supabase.from('user_profiles').insert({ id: user.id });
                };
                fetchProfile();

                // Realtime Notification Listener
                if (user && supabase) {
                    const channel = supabase.channel('realtime:notifications')
                        .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'user_profiles', filter: `id=eq.${user.id}` }, (payload) => {
                            if (payload.new && payload.new.notifications) {
                                const newNotifs = payload.new.notifications;
                                setNotificationHistory(newNotifs);
                                setUnreadCount(newNotifs.filter(n => !n.is_read).length);
                            }
                        }).subscribe();
                    return () => { supabase.removeChannel(channel); };
                }
            }, [user]);

            const handleUpdateWatchlist = async (newWatchlist) => {
                setWatchlist(newWatchlist);
                if (user && supabase) await supabase.from('user_profiles').update({ watchlist: newWatchlist }).eq('id', user.id);
            };

            return (
                <div className="min-h-screen text-slate-300 font-sans selection:bg-blue-500/30 pb-20">
                    <div className="max-w-4xl mx-auto p-4">
                        <header className="flex justify-between items-center mb-6 relative">
                            <div className="flex items-center gap-3"><div className="relative"><div className="absolute inset-0 bg-blue-500 blur-lg opacity-20 rounded-full"></div><img src="./app-icon.png" alt="Smart DCA Logo" className="w-10 h-10 rounded-xl shadow-lg relative z-10" /></div><div><h1 className="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400 tracking-tight">Smart DCA</h1><p className="text-xs text-slate-500 font-medium tracking-wide">INTELLIGENT INVESTING</p></div></div>
                            <div className="flex items-center gap-3"><AuthComponent user={user} setUser={setUser} isPremium={isPremium} /></div>
                        </header>
                        <nav className="flex p-1 bg-slate-800/50 backdrop-blur-md rounded-xl mb-6 border border-slate-700/50 sticky top-4 z-50 shadow-xl">
                            <button onClick={() => setActiveTab('crypto')} className={`flex-1 py-2.5 rounded-lg text-sm font-bold transition-all flex items-center justify-center gap-2 ${activeTab === 'crypto' ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:bg-slate-700/50'}`}>åŠ å¯†è²¨å¹£</button>
                            <button onClick={() => setActiveTab('stock')} className={`flex-1 py-2.5 rounded-lg text-sm font-bold transition-all flex items-center justify-center gap-2 ${activeTab === 'stock' ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:bg-slate-700/50'}`}>ç¾è‚¡å¸‚å ´</button>
                            <button onClick={() => setActiveTab('taiwan')} className={`flex-1 py-2.5 rounded-lg text-sm font-bold transition-all flex items-center justify-center gap-2 ${activeTab === 'taiwan' ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:bg-slate-700/50'}`}>å°è‚¡å¸‚å ´</button>
                            {user && <button onClick={() => setActiveTab('watchlist')} className={`flex-1 py-2.5 rounded-lg text-sm font-bold transition-all flex items-center justify-center gap-2 ${activeTab === 'watchlist' ? 'bg-yellow-600 text-white shadow-lg' : 'text-slate-400 hover:bg-slate-700/50'}`}>æˆ‘çš„è‡ªé¸</button>}
                        </nav>
                        <main>
                            {loading ? <div className="flex justify-center py-20"><RefreshCw className="animate-spin text-slate-500" /></div> : (
                                <>
                                    {activeTab === 'crypto' && <CryptoDashboard notificationsEnabled={false} toggleNotifications={() => { }} userInfo={{ isPremium, watchlist, email: user?.email }} onUpdateWatchlist={handleUpdateWatchlist} />}
                                    {activeTab === 'stock' && <StockDashboard userInfo={{ isPremium, watchlist, email: user?.email }} onUpdateWatchlist={handleUpdateWatchlist} />}
                                    {activeTab === 'taiwan' && <TaiwanDashboard userInfo={{ isPremium, watchlist, email: user?.email }} onUpdateWatchlist={handleUpdateWatchlist} />}
                                    {activeTab === 'watchlist' && <WatchlistDashboard watchlist={watchlist} onUpdateWatchlist={handleUpdateWatchlist} isPremium={isPremium} user={user} />}
                                </>
                            )}
                        </main>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
